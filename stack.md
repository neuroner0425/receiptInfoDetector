# 영수증 OCR 백엔드 기술스택 및 처리과정 상세

## 1. 전체 기술 스택 개요
- **애플리케이션 서버:** `Flask`
  - 엔드포인트 제공 (`/detect`, `/process`)
  - 파일 업로드 및 비동기 작업 트리거
- **비동기 처리:** `Celery`
  - 작업 큐 처리 (영수증 OCR + 파싱)
  - 확장성(워커 수 증가)을 통한 처리량 향상
- **브로커 & 결과 백엔드:** `Redis`
  - 태스크 전달 및 (현재 코드상) 결과 저장은 직접 파일로, 상태 질의는 파일 존재 여부로 판별
- **OCR 엔진:** `PaddleOCR`
  - 다국어(Korean, English) 인식 시도
- **텍스트 후처리 / Fuzzy Matching:** `rapidfuzz`
  - OCR 단어를 사전(`FUZZY_KEYWORDS`) 기반으로 교정
- **이미지 처리:** `OpenCV (cv2)`
  - 이미지 로드 및 후속 전처리에 활용 (향후 확대 가능)
- **문자열 정규화:** `re`, `unicodedata`
- **데이터 직렬화:** `json`
- **디렉터리/세션 관리:** `os`, `uuid`
- **기타:** `datetime`, `collections.defaultdict`
- **배포 실행 예시:** `gunicorn` (멀티 워커 WSGI 서버)
- **잠재적 확장 라이브러리(추정):** `numpy` (Paddle/OPEN CV 내부 사용)

## 백엔드 비동기 파이프라인 (Celery 워커 내부):
1. 입력 이미지 로드 (`cv2.imread`)
2. PaddleOCR 실행 (한국어 → 영어 순회)
3. OCR 결과(박스/텍스트/신뢰도) 수집 및 중복 제거
4. 단어 단위 -> 라인 단위 그룹핑 (`group_lines`)
5. 라인 텍스트 정규화 / Fuzzy 보정:
   - 전각→반각, 숫자 오탈자 (`O→0`, `I→1` 등)
   - 도메인 키워드 사전 기반 rapidfuzz 매칭
6. 메타 정보 추출:
   - 상호명 `pick_store_name`
   - 주소 `pick_address`
   - 전화번호 `pick_phone`
   - 거래/승인 시각 `pick_datetime`
   - 결제수단/브랜드 `pick_payment_method`
   - 고객/회원 정보 `pick_user_info`
7. 품목 테이블 탐지:
   - 헤더 힌트 탐색 (`품목`, `단가`, `수량`, `금액` 등)
   - 헤더 이후 ~ 합계/결제 관련 키워드 전까지 범위 추정
   - 각 라인 열 분해(`split_columns_by_alignment`) → 이름/수량/단가/소계
   - 결측 값 보정 (단가*수량=소계 역산 등)
8. 합계 계산:
   - 라인 중 결제/합계 키워드 포함 텍스트에서 금액 파싱 (`pick_receipt_total`)
   - 실패 시 품목 소계 합산/또는 하단 큰 숫자 heuristic
9. JSON 구조 구성 및 `result.json` 저장

## 4. 주요 알고리즘/전처리 디테일

### 4.1 라인 그룹핑 (`group_lines`)
- OCR 단어들에 대해 사각형 박스 → 중심좌표/높이 계산
- `cy`(y 중심) 기반 정렬
- 이전 라인과 y 겹침 비율(`y_merge_ratio=0.6`) 판단 → 같은 라인 묶기
- 라인 내부 x 정렬 후 텍스트 join

### 4.2 Fuzzy 교정
- 토큰 길이 필터 (`2 ≤ len ≤ 12`)
- 숫자/기호-only 제외
- rapidfuzz `QRatio` 로 vocabulary 와 BestMatch
- 스코어 ≥ 86 일 때 치환
- 금액/숫자-only 라인은 skip (성능/오차 최소화)

### 4.3 숫자/금액 파싱 (`amount_from_text`)
- `(2,000)` → 음수 처리
- 할인/환급 키워드 감지 시 negative flag
- 마지막 등장 숫자를 우선 (한국 영수증 패턴 경험 기반)
- `1,000`, `10 000` 등 다양한 구분자 제거 후 정수화

### 4.4 품목 파싱
- 라인 끝에 연속된 2~3개 숫자 토큰 → (수량, 단가, 소계) 패턴 추정
- `2개`, `@1,000`같은 변형 수용
- 잘못된 헤더/합계/쿠폰/할인 라인 필터
- 부분 결측 역산 로직으로 데이터 정합성 향상

### 4.5 메타 추출 로직
- 상호명: 상단 25% 영역, 크기(높이*폭) 기준 Max
- 주소: 주소 형태 패턴 (`도|시|구|로|길` + 숫자 등)
- 시간: 여러 패턴 시도 → 가장 늦은 시간 선택
- 결제수단: 카드사/간편결제 키워드 우선, 현금/카드 구분